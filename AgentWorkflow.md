# Agent Workflow History — DocBrain RAG SaaS

**Last Updated**: 2025-12-09T10:16:00 (Taiwan Time, UTC+8)

## Modification History

| Timestamp (Taiwan) | Action | Files Modified | Details | Status |
|---|---|---|---|---|
| 2025-12-06T17:10:00 | Repository Analysis | N/A | Read 100+ files across backend and frontend | ✅ |
| 2025-12-06T18:30:00 | Logging Implementation (Phase 1/3) | auth.py endpoints | Added logging to register/login endpoints | ✅ |
| 2025-12-06T19:15:00 | Logging Implementation (Phase 2/3) | auth.py, chat.py, chatbot.py, ingestion.py services | Added comprehensive logs to service layer | ✅ |
| 2025-12-06T20:00:00 | Logging Implementation (Phase 3/3) | conversation.py, documents.py endpoints | Added request/response tracing | ✅ |
| 2025-12-06T22:00:00 | Plan.md Creation | Plan.md | Created project execution plan with 6 phases | ✅ |
| 2025-12-07T12:45:00 | Repository Pattern Init | repositories/chatbot.py, repositories/document.py, services/ingestion.py, api/deps.py | Scaffolded ChatbotRepository and DocumentRepository; refactored IngestionService | ✅ |
| 2025-12-07T13:15:00 | CRUD Endpoints Implementation | endpoints/chatbots.py, endpoints/documents.py, endpoints/settings.py, services/chatbot.py, services/tenant.py, schemas.py, api/deps.py | Implemented full CRUD for chatbots, documents, and tenant settings | ✅ |
| 2025-12-07T16:30:00 | Complete Repository Pattern + Service Refactor | services/account.py, services/chat.py, services/tenant.py, repositories/account.py, repositories/tenant.py, repositories/conversation.py, api/deps.py | Extracted all DB operations from AccountService, ChatService, ChatbotService, TenantService into dedicated repositories; updated DI | ✅ |
| 2025-12-07T16:50:12 | deps.py Update (DI fixes) | api/deps.py, services/auth.py | Fixed DI: inject AuthRepository into AuthService; ensured ChatService constructs ChatbotService with AsyncSession (avoids repository/db mismatch) | ✅ |
| 2025-12-07T17:11:03 | Frontend + Backend Signup Validation | frontend/src/app/(auth)/register/page.tsx, api/endpoints/auth.py, app/schemas.py, core/security.py | Added client-side validation (min 8 chars, max 30 chars, requires uppercase/lowercase/digit), removed special-char requirement, set bcrypt_sha256 to handle long passwords, return per-violation errors as structured { "errors": [...] } | ✅ |
| 2025-12-07T17:29:29 | API Key Empty Value Fix | frontend/src/types/index.ts, frontend/src/app/(auth)/register/page.tsx | Fixed issue where empty API key fields were sent as empty strings instead of null; separated SignupFormData (form state with strings) from SignupRequest (API payload allowing null); convert empty keys to null before sending to backend | ✅ |
| 2025-12-07T08:15:00 | Migrate hashing to Pwdlib (Argon2id) & model length fixes | app/core/security.py, pyproject.toml, app/models/tenant.py, app/models/document.py, app/models/conversation.py, alembic/versions/a56dd038fe22_*.py | Replaced Passlib bcrypt usage with `pwdlib` Argon2id recommended hasher; removed `passlib[bcrypt]` from `pyproject.toml`; tightened/expanded DB column types (encrypted API key columns set to `String(512)`, document `error_message` to `String(1024)`, message `content` changed to `Text`, LlamaIndexStore text to `Text`); created Alembic migration for column type changes | ✅ |
| 2025-12-07T08:45:00 | Fix register transaction atomicity | app/services/auth.py, app/repositories/auth.py | Refactored AuthService.register() to use single commit with intermediate flush() calls instead of multiple commits; prevents orphaned Tenant/Account records on error; added flush() method to AuthRepository | ✅ |
| 2025-12-07T09:20:00 | Session configuration update | app/db/session.py | Added `expire_on_commit=False` to SessionLocal configuration to prevent SQLAlchemy attribute expiration errors after commit; allows accessing ORM object attributes without triggering DB reload | ✅ |
| 2025-12-07T10:10:00 | Backend login endpoint JSON format | app/schemas.py, app/api/endpoints/auth.py | Added `LoginRequest` schema with `email: EmailStr` and `password: str` fields; modified /login endpoint to accept JSON `LoginRequest` instead of OAuth2PasswordRequestForm; updated all references from `form_data.username` to `credentials.email` | ✅ |
| 2025-12-07T10:35:00 | Frontend login JSON format migration | frontend/src/lib/api.ts, frontend/src/components/providers/AuthProvider.tsx, frontend/src/app/(auth)/login/page.tsx | Updated authService.login to accept `{ email: string; password: string }` instead of FormData; modified AuthProvider login signature and implementation; removed FormData creation from login page, now sends JSON directly; aligns frontend with backend LoginRequest schema | ✅ |
| 2025-12-08T14:20:00 | Register missing API endpoints | app/api/api.py | Added chatbots and settings router registration to main API router; imported chatbots and settings endpoints; now all endpoints in endpoints/ directory are properly registered and accessible | ✅ |
| 2025-12-08T14:40:00 | Fix chatbot endpoints schema | app/api/endpoints/chatbots.py, app/schemas.py | Fixed DELETE endpoint to return None for HTTP 204; added rag_config field to ChatbotRead/ChatbotResponse/ChatbotUpdate schemas; updated all chatbot endpoints (list, create, get, update) to return rag_config; added tenant_id auto-injection from current_user in create endpoint | ✅ |
| 2025-12-08T15:05:00 | Standardize config field naming (snake_case) | app/models/config_schemas.py, app/models/chatbot.py, app/services/chatbot.py | Created RagConfigSchema and WidgetConfigSchema with strict snake_case field definitions; updated Chatbot model to use schema defaults; updated ChatbotService.create_chatbot() and update_chatbot() to normalize camelCase inputs to snake_case using Pydantic schemas; ensures consistent storage format (primary_color, welcome_message, chunking_strategy, etc.) | ✅ |
| 2025-12-08T15:15:00 | Align RAG/Chunking strategies with core modules | app/models/config_schemas.py, frontend/src/types/index.ts | Updated RagMode enum: removed "fast"/"precise", added "sentence_window"/"parent_child"; kept ChunkingStrategy unchanged (standard/markdown/semantic/window); frontend RagMode enum now matches backend RAGStrategy class from rag_strategies.py | ✅ |
| 2025-12-08T15:20:00 | Fix documents API routing | app/api/endpoints/documents.py, frontend/src/lib/api.ts | Changed documents route from `/chatbots/{chatbot_id}/documents` to `/{chatbot_id}/documents` to match `/document` prefix; updated frontend documentService.list to request `/document/{chatbotId}/documents` instead of `/chatbots/{chatbotId}/documents` | ✅ |
| 2025-12-08T15:40:00 | Upgrade ingestion confirmation to AlertDialog | frontend/src/components/chatbot-detail/KnowledgeTab.tsx | Replaced native `confirm()` alert with styled AlertDialog component; enhanced confirmation modal to display Chunking Strategy and Retrieval Mode; added warning that these settings will be permanently locked once ingestion completes; improved UX with better visual hierarchy and messaging | ✅ |
| 2025-12-08T16:50:00 | Fix controlled input warning in ConfigTab | frontend/src/components/chatbot-detail/ConfigTab.tsx | Added default values for rag_config and widget_config in useState initialization to prevent undefined to defined value transitions; ensures all form inputs are controlled from component mount | ✅ |
| 2025-12-08T17:05:00 | Fix settings API routing | app/api/endpoints/settings.py, frontend/src/lib/api.ts | Changed settings routes from `/tenant/settings` to `/tenant` to properly work with `/settings` prefix; updated frontend to request `/settings/tenant` for both GET and PATCH operations; corrected full API paths to `/api/settings/tenant` | ✅ |
| 2025-12-08T17:11:00 | Fix controlled input warning in SettingsPage | frontend/src/app/(dashboard)/settings/page.tsx, frontend/src/types/index.ts | Updated TenantSettings type to match backend response (openai_key_configured/llama_cloud_key_configured booleans instead of strings); initialized keys state with empty strings instead of undefined to prevent controlled input warnings; added dynamic placeholder based on configured status | ✅ |
| 2025-12-08T17:20:00 | Add LLM Model to RAG Configuration | app/models/config_schemas.py, frontend/src/types/index.ts, frontend/src/components/chatbot-detail/ConfigTab.tsx, frontend/src/app/(dashboard)/chatbots/new/page.tsx | Added llm_model field to RagConfigSchema with default "gpt-4o-mini"; updated frontend RagConfig interface with llm_model; added LLM Model selector dropdown in ConfigTab with 4 options (gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo); initialized default llm_model in both ConfigTab and CreateChatbotPage; enables per-chatbot LLM model selection for chat generation | ✅ |
| 2025-12-08T17:38:00 | Change llm_model to Literal type | app/models/config_schemas.py | Changed llm_model from str to Literal["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-3.5-turbo"] for strict type validation; ensures only valid GPT models can be assigned | ✅ |
| 2025-12-09T10:16:00 | Refactor services for code quality | app/services/chatbot.py, app/services/ingestion.py | **chatbot.py**: Extracted 3 helper methods to reduce update_chatbot cognitive complexity (23→8): _normalize_widget_config, _normalize_rag_config, _apply_field_update, _should_update_field, _commit_update. **ingestion.py**: Reduced ingest_file cognitive complexity (16→8) by extracting 5 helper methods: _write_file_async, _retrieve_tenant_keys, _parse_and_chunk_documents, _inject_node_metadata, _write_to_vector_store. Fixed 4 security/async issues: (1) Replaced f-string without args with plain string, (2) Replaced sync tempfile.NamedTemporaryFile with async anyio.open_file, (3) Prevented log injection by removing user-controlled data from error logs, (4) Changed error responses to not leak internal details | ✅ |

